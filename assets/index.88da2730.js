var D=Object.defineProperty,$=Object.defineProperties;var j=Object.getOwnPropertyDescriptors;var b=Object.getOwnPropertySymbols;var B=Object.prototype.hasOwnProperty,A=Object.prototype.propertyIsEnumerable;var h=(o,e,t)=>e in o?D(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t,f=(o,e)=>{for(var t in e||(e={}))B.call(e,t)&&h(o,t,e[t]);if(b)for(var t of b(e))A.call(e,t)&&h(o,t,e[t]);return o},R=(o,e)=>$(o,j(e));var l=(o,e,t)=>(h(o,typeof e!="symbol"?e+"":e,t),t);import{j as L,a as O,F as I,y as g,s as S,A as w,b as T,S as _}from"./vendor.ee36fd45.js";const k=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerpolicy&&(r.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?r.credentials="include":n.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}};k();const i=L,p=O,y=I,F=`javascript:(() => {
	window.__FREMOTE_BASE_URL__ = "${location.origin}";
	const script = document.createElement("script");
	script.src = "${location.origin}/inject.js";
	document.head.appendChild(script);
})();`.replace(/\n\s+/g,""),x=`javascript:(() => {
	window.__FREMOTE_BASE_URL__ = "${location.origin}";
	const btn = document.body.appendChild(document.createElement("button"));
	btn.innerText = "FRemote";
	btn.style.position = "fixed";
	btn.style.top = "0";
	btn.style.right = "0";
	btn.style.zIndex = "9999";
	btn.addEventListener("click", () => {
		const script = document.createElement("script");
		script.src = "${location.origin}/inject.js";
		document.head.appendChild(script);
	});
})();`.replace(/\n\s+/g,"");function N(){return p(y,{children:["Drag links to bookmarks",i("p",{}),p("div",{children:[p("div",{children:["One click bookmark: ",i("a",{href:F,children:"FRemote"})]}),p("div",{children:['Add "FRemote" Button bookmark: ',i("a",{href:x,children:"Add Fremote Button"})]})]})]})}function U(){new BroadcastChannel("fremote").addEventListener("message",e=>{const t=R(f({},e.data),{namespace:"fremote"});console.log("bridge:",t),window.top.postMessage(t,"*")})}function P(){return g(()=>{U()},[]),null}const C=class{constructor(){l(this,"pc");l(this,"dc");l(this,"roomId");this.pc=new RTCPeerConnection(C.RTCConfiguration)}send(e,t){this.dc.send(JSON.stringify(f({type:e},t)))}on(e,t){this.dc.addEventListener("message",s=>{const n=JSON.parse(s.data);n.type===e&&t(n)})}once(e,t){this.dc.addEventListener("message",s=>{const n=JSON.parse(s.data);n.type===e&&(t(n),this.dc.removeEventListener("message",t))})}_listenOnDataChannel(e){e.onopen=()=>{console.log("dc.onopen")},e.onclose=()=>{console.log("dc.onclose")},e.onmessage=t=>{console.log("dc.onmessage",t)},e.onerror=t=>{console.log("dc.onerror",t)}}};let a=C;l(a,"ApiBaseUrl",location.origin+"/api"),l(a,"RTCConfiguration",{iceServers:[]});const v=class extends a{constructor(){super();l(this,"bc");this.dc=this.pc.createDataChannel("fremote"),this.bc=this._createBroadcastChannel(),this.dc.addEventListener("message",e=>{const t=JSON.parse(e.data);t.type[0]!=="$"&&this.bc.postMessage(t)}),window._peer=this}_createBroadcastChannel(){const e=new BroadcastChannel("fremote");return e.addEventListener("message",t=>{console.log("assist:",t)}),window.bc=e,e}async create(){const e=await this.pc.createOffer();await this.pc.setLocalDescription(e);const t=await new Promise((r,c)=>{this.pc.onicecandidate=d=>{if(d.candidate===null){const m=this.pc.localDescription;r(m)}}}),s=await fetch(`${a.ApiBaseUrl}/room`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({offer:t})}),{roomId:n}=await s.json();console.log("roomId",n),this.roomId=n}async connect(){if(!this.roomId)throw new Error("roomId is not set");const e=await this._pullAnswer(this.roomId);console.log("answer",e),this.pc.setRemoteDescription(e)}async _pullAnswer(e){return new Promise((t,s)=>{const n=window.setTimeout(()=>{window.clearInterval(r),s("timeout")},v.ConnectionTimeout),r=window.setInterval(async()=>{const c=await fetch(`${a.ApiBaseUrl}/room/${e}`),{answer:d}=await c.json();d&&(window.clearTimeout(n),window.clearInterval(r),t(d))},1e3)})}async addScreenStream(){this.pc.onnegotiationneeded=async()=>{const s=await this.pc.createOffer();await this.pc.setLocalDescription(s);const n=this.pc.localDescription;this.send("$offer",{offer:n})},this.once("$answer",({answer:s})=>{this.pc.setRemoteDescription(s)});const e=await navigator.mediaDevices.getDisplayMedia({video:!0}),t=e.getVideoTracks()[0];this.pc.addTrack(t,e)}};let u=v;l(u,"ConnectionTimeout",6e4);class J extends a{constructor(){super();this.pc.ondatachannel=e=>{e.channel&&(this.dc=e.channel,this.once("$offer",async({offer:t})=>{await this.pc.setRemoteDescription(t);const s=await this.pc.createAnswer();await this.pc.setLocalDescription(s);const n=this.pc.localDescription;this.send("$answer",{answer:n})}))},window._peer=this}async connect(e){const t=await fetch(`${a.ApiBaseUrl}/room/${e}`),{offer:s}=await t.json();await this.pc.setRemoteDescription(s);const n=await this.pc.createAnswer();await this.pc.setLocalDescription(n);const r=await new Promise((c,d)=>{this.pc.onicecandidate=m=>{if(m.candidate===null){const E=this.pc.localDescription;c(E)}}});await fetch(`${a.ApiBaseUrl}/room/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({answer:r})})}}function M(o){const{roomId:e}=o,t=S(null);g(()=>{if(!e)throw new Error("No roomId");(async()=>{const c=new J;c.pc.ontrack=d=>{const m=document.getElementById("screen-mirror");m.srcObject=d.streams[0],m.play()},await c.connect(e),t.current=c})()},[]);const s=w(()=>{t.current.send("prev")},[]),n=w(()=>{t.current.send("next")},[]),r=w(()=>{t.current.send("fullscreen")},[]);return p(y,{children:[i("video",{id:"screen-mirror",style:"width:100vw;",controls:!0}),p("div",{style:{display:"flex",justifyContent:"space-evenly",width:"100vw",padding:"1rem"},children:[i("span",{class:"button",onClick:s,children:"\u2190"}),i("span",{class:"button",onClick:r,children:"\u{1F4FD}\uFE0F"}),i("span",{class:"button",onClick:n,children:"\u2192"})]})]})}const q=location.origin,H=o=>{const e=document.getElementById("qr");T.toCanvas(e,o,function(t){t&&console.error(t),console.log("qr success!",o)})};function V(){return g(()=>{(async()=>{const o=new u;await o.create();const e=`${q}?room-id=${o.roomId}`;H(e),await o.connect(),await o.addScreenStream()})()},[]),p(y,{children:[i("div",{children:"FRemote"}),i("div",{children:i("canvas",{id:"qr"})}),"Valid in ",u.ConnectionTimeout/1e3,"s"]})}function z(){const o=new URLSearchParams(location.search),e=o.get("page"),t=o.get("room-id");return e==="bridge"?(document.title+=" - Bridge",i(P,{})):e==="assist"?(document.title+=" - Assist",i(V,{})):t?(document.title+=" - Remote Controller",i(M,{roomId:t})):(document.title+=" - Home",i(N,{}))}_(i(z,{}),document.getElementById("app"));
